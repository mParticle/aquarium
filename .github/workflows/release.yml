name: Release Aquarium

on:
    workflow_dispatch:

jobs:
    # release is done from master branch.
    confirm-public-repo-master-branch:
        name: 'Confirm release is run from public/master branch'
        uses: mParticle/mparticle-workflows/.github/workflows/sdk-release-repo-branch-check.yml@main

    build-release:
        name: Build Distribution Assets
        runs-on: ubuntu-latest
        needs: confirm-public-repo-master-branch
        steps:
            - name: Checkout
              uses: actions/checkout@v3
              with:
                  ref: main

            - name: NPM install
              uses: actions/setup-node@v3
              with:
                  node-version: 16.x

            - name: Run NPM CI
              run: npm ci

            - name: Run Build Dist
              run: npm run build-dist

            - name: Archive npm failure logs
              uses: actions/upload-artifact@v2
              if: failure()
              with:
                  name: npm-logs
                  path: ~/.npm/_logs

    release:
        name: Perform Release
        runs-on: ubuntu-latest
        needs:
            - build-release
        env:
            GITHUB_TOKEN: ${{ secrets.MP_SEMANTIC_RELEASE_BOT }}
            GIT_AUTHOR_NAME: mparticle-automation
            GIT_AUTHOR_EMAIL: developers@mparticle.com
            GIT_COMMITTER_NAME: mparticle-automation
            GIT_COMMITTER_EMAIL: developers@mparticle.com
            NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

        steps:
            - name: Checkout public master branch
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0
                  ref: main

            - name: Import GPG Key
              uses: crazy-max/ghaction-import-gpg@v4
              with:
                  gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
                  passphrase: ${{ secrets.GPG_PASSPHRASE }}
                  git_user_signingkey: true
                  git_commit_gpgsign: true

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 16.x

            - name: Install dependencies
              run: npm ci

            - name: Release
              run: |
                  npx semantic-release

            - name: Archive npm failure logs
              uses: actions/upload-artifact@v3
              if: failure()
              with:
                  name: npm-logs
                  path: ~/.npm/_logs 
